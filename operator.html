<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Voight-Kampff Console — Tyrell CO.</title>
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <div class="frame">
    
    <!-- Top bar -->
    <div class="top-bar">
      <span class="slot" id="slotFan">FAN: —</span>
      <span class="slot" id="slotIris">IRIS: OFF</span>
      <span class="slot" id="slotAudio">AUDIO: —</span>
      <span class="slot" id="slotVideo">VIDEO: —</span>
      <span class="slot" id="slotProfile">PROFILE: NONE</span>
      <span class="status-main" id="slotStatus">SYSTEM IDLE</span>
    </div>
    
    <!-- Workspace with panels -->
    <div class="workspace" id="workspace">
      
      <!-- Voice Panel: 400x400 base -->
      <div class="panel" id="voicePanel" data-base-w="400" data-base-h="400">
        <canvas id="voiceCanvas" width="400" height="400"></canvas>
      </div>
      
      <!-- Left VU Meter: 400x40 base, below voice panel -->
      <div class="vu-meter" id="vuMeterLeft" data-base-w="400" data-base-h="40">
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#e0e0e0"></div>
        <div class="vu-segment" style="background:#e0e0e0"></div>
        <div class="vu-segment" style="background:#e0e0e0"></div>
      </div>
      
      <!-- IRIS Panel: 800x800 base -->
      <div class="panel" id="irisPanel" data-base-w="800" data-base-h="800">
        <video id="irisVideo" autoplay muted playsinline></video>
        <div class="color-bars" id="irisBars"><span>TYRELL CO.</span></div>
        <div class="placeholder" id="irisPlaceholder">TYRELL CO.</div>
      </div>
      
      <!-- Nexus Panel: 400x400 base -->
      <div class="panel" id="nexusPanel" data-base-w="400" data-base-h="400">
        <canvas id="nexusCanvas" width="400" height="400"></canvas>
      </div>
      
      <!-- Right VU Meter: 400x40 base, below nexus panel -->
      <div class="vu-meter" id="vuMeterRight" data-base-w="400" data-base-h="40">
        <div class="vu-segment" style="background:#00cc00"></div>
        <div class="vu-segment" style="background:#00cc00"></div>
        <div class="vu-segment" style="background:#00cc00"></div>
        <div class="vu-segment" style="background:#00cc00"></div>
        <div class="vu-segment" style="background:#00cc00"></div>
        <div class="vu-segment" style="background:#00cc00"></div>
        <div class="vu-segment" style="background:#cccc00"></div>
        <div class="vu-segment" style="background:#cccc00"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
        <div class="vu-segment" style="background:#cc0000"></div>
      </div>
      
    </div>
    
    <!-- Bottom bar -->
    <div class="bottom-bar">
      <span class="info"><span class="label">ROM:</span> <span class="value" id="romStatus">NONE</span></span>
      <span class="info"><span class="label">MODE:</span> <span class="value" id="modeStatus">STANDBY</span></span>
      <span class="spacer"></span>
      <button class="ctrl-btn" id="btnK">[K] TOKEN</button>
      <button class="ctrl-btn" id="btnI">[I] IRIS</button>
      <button class="ctrl-btn" id="btnF">[F] FAN</button>
      <button class="ctrl-btn" id="btnD">[D] DISPLAY</button>
      <button class="ctrl-btn" id="btnSpace">[SPACE] INITIATE</button>
    </div>
    
  </div>

  <script src="js/shared.js"></script>
  <script src="js/voice.js"></script>
  <script src="js/nexus.js"></script>
  <script src="js/vu-meters.js"></script>
  <script>
    // DOM refs
    const workspace = document.getElementById("workspace");
    const voicePanel = document.getElementById("voicePanel");
    const irisPanel = document.getElementById("irisPanel");
    const nexusPanel = document.getElementById("nexusPanel");
    const vuMeterLeft = document.getElementById("vuMeterLeft");
    const vuMeterRight = document.getElementById("vuMeterRight");
    const irisVideo = document.getElementById("irisVideo");
    const irisBars = document.getElementById("irisBars");
    const irisPlaceholder = document.getElementById("irisPlaceholder");
    
    const slotStatus = document.getElementById("slotStatus");
    const slotFan = document.getElementById("slotFan");
    const slotIris = document.getElementById("slotIris");
    const slotAudio = document.getElementById("slotAudio");
    const slotVideo = document.getElementById("slotVideo");
    const slotProfile = document.getElementById("slotProfile");
    const romStatus = document.getElementById("romStatus");
    const modeStatus = document.getElementById("modeStatus");
    
    const btnK = document.getElementById("btnK");
    const btnI = document.getElementById("btnI");
    const btnF = document.getElementById("btnF");
    const btnD = document.getElementById("btnD");
    const btnSpace = document.getElementById("btnSpace");
    
    // Init panels
    VoicePanel.init("voiceCanvas");
    NexusPanel.init("nexusCanvas");
    VUMeters.init("vuMeterLeft", "vuMeterRight");
    
    // Layout panels proportionally
    // Base sizes: Voice 400x400, IRIS 800x800, Nexus 400x400
    // Total base width: 400 + 800 + 400 = 1600
    // Total base height: max = 800
    // Gap between panels: 20px (2 gaps = 40px)
    
    function layoutPanels() {
      const ws = workspace.getBoundingClientRect();
      const gap = 20;
      const vuGap = 10; // gap between panel and VU meter
      const vuHeight = 5; // compact VU meters
      const baseTotal = 1600 + gap * 2; // 400 + 800 + 400 + gaps
      const baseHeight = 800;
      
      // Scale to fit workspace
      const scaleW = ws.width / baseTotal;
      const scaleH = ws.height / baseHeight;
      const scale = Math.min(scaleW, scaleH);
      
      const voiceW = 400 * scale;
      const voiceH = 400 * scale;
      const irisW = 800 * scale;
      const irisH = 800 * scale;
      const nexusW = 400 * scale;
      const nexusH = 400 * scale;
      const scaledGap = gap * scale;
      const scaledVuGap = vuGap * scale;
      const scaledVuH = vuHeight * scale;
      
      // Total scaled width
      const totalW = voiceW + irisW + nexusW + scaledGap * 2;
      const startX = (ws.width - totalW) / 2;
      
      // Center vertically
      const voiceY = (ws.height - voiceH) / 2;
      const irisY = (ws.height - irisH) / 2;
      const nexusY = (ws.height - nexusH) / 2;
      
      // Position panels
      voicePanel.style.left = startX + "px";
      voicePanel.style.top = voiceY + "px";
      voicePanel.style.width = voiceW + "px";
      voicePanel.style.height = voiceH + "px";
      
      irisPanel.style.left = (startX + voiceW + scaledGap) + "px";
      irisPanel.style.top = irisY + "px";
      irisPanel.style.width = irisW + "px";
      irisPanel.style.height = irisH + "px";
      
      nexusPanel.style.left = (startX + voiceW + scaledGap + irisW + scaledGap) + "px";
      nexusPanel.style.top = nexusY + "px";
      nexusPanel.style.width = nexusW + "px";
      nexusPanel.style.height = nexusH + "px";
      
      // Position VU meters below voice and nexus panels
      vuMeterLeft.style.left = startX + "px";
      vuMeterLeft.style.top = (voiceY + voiceH + scaledVuGap) + "px";
      vuMeterLeft.style.width = voiceW + "px";
      vuMeterLeft.style.height = scaledVuH + "px";
      
      vuMeterRight.style.left = (startX + voiceW + scaledGap + irisW + scaledGap) + "px";
      vuMeterRight.style.top = (nexusY + nexusH + scaledVuGap) + "px";
      vuMeterRight.style.width = nexusW + "px";
      vuMeterRight.style.height = scaledVuH + "px";
    }
    
    layoutPanels();
    window.addEventListener("resize", layoutPanels);
    
    // Key handling
    let spaceDown = false;
    
    document.addEventListener("keydown", (e) => {
      if (VK.checkTechnicianAccess(e)) return;
      const key = e.key.toLowerCase();
      
      if (key === "k") handleToken();
      else if (key === "i") handleIris();
      else if (key === "f") handleFan();
      else if (key === "d") handleDisplay();
      else if (key === " " && !spaceDown) {
        spaceDown = true;
        handleInitiate();
        e.preventDefault();
      }
    });
    
    document.addEventListener("keyup", (e) => {
      if (e.key === " ") spaceDown = false;
    });
    
    // Button handlers
    btnK.addEventListener("click", handleToken);
    btnI.addEventListener("click", handleIris);
    btnF.addEventListener("click", handleFan);
    btnD.addEventListener("click", handleDisplay);
    btnSpace.addEventListener("click", handleInitiate);
    
    function handleToken() {
      VK.requestToken().then(success => {
        if (success) {
          irisVideo.srcObject = VK.mediaStream;
          setStatus("TOKEN VERIFIED");
          updateUI();
        }
      });
    }
    
    function handleIris() {
      if (!VK.hasToken) return;
      VK.irisTargetActive = !VK.irisTargetActive;
      setStatus(VK.irisTargetActive ? "IRIS DEPLOYING" : "IRIS RETRACTING");
      VK.broadcastState();
    }
    
    function handleFan() {
      if (!VK.hasToken) return;
      VK.fanOn = !VK.fanOn;
      setStatus(VK.fanOn ? "FAN ACTIVE" : "FAN OFF");
      VK.broadcastState();
      updateUI();
    }
    
    function handleDisplay() {
      if (!VK.hasToken) return;
      if (VK.irisState !== "ACTIVE") {
        setStatus("IRIS NOT DEPLOYED");
        return;
      }
      VK.displayOn = !VK.displayOn;
      setStatus(VK.displayOn ? "DISPLAYS ACTIVE" : "DISPLAYS OFF");
      VK.broadcastState();
      updateUI();
    }
    
    function handleInitiate() {
      if (!VK.hasToken) return;
      if (!VK.displayOn || VK.irisState !== "ACTIVE") {
        setStatus("CANNOT INITIATE — DISPLAYS OFF OR IRIS NOT ACTIVE");
        return;
      }
      VK.analysisRunning = !VK.analysisRunning;
      setStatus(VK.analysisRunning ? "TEST SEQUENCE RUNNING" : "TEST SEQUENCE HALTED");
      VK.broadcastState();
      updateUI();
    }
    
    function setStatus(text) {
      slotStatus.textContent = text;
      VK.logEvent("STATUS: " + text);
    }
    
    function updateUI() {
      // Buttons
      btnK.classList.toggle("active", VK.hasToken);
      btnI.classList.toggle("active", VK.irisTargetActive || VK.irisState !== "OFF");
      btnF.classList.toggle("active", VK.fanOn);
      btnD.classList.toggle("active", VK.displayOn);
      btnSpace.classList.toggle("active", VK.analysisRunning);
      btnSpace.textContent = VK.analysisRunning ? "[SPACE] TERMINATE" : "[SPACE] INITIATE";
      
      // Status slots
      slotFan.textContent = "FAN: " + (VK.fanOn ? "ON" : "—");
      slotFan.classList.toggle("ready", VK.fanOn);
      
      slotIris.textContent = "IRIS: " + VK.irisState;
      slotIris.classList.toggle("ready", VK.irisState === "ACTIVE");
      
      slotAudio.textContent = "AUDIO: " + (VK.hasToken ? "READY" : "—");
      slotAudio.classList.toggle("ready", VK.hasToken);
      
      slotVideo.textContent = "VIDEO: " + (VK.irisState === "ACTIVE" ? "READY" : "—");
      slotVideo.classList.toggle("ready", VK.irisState === "ACTIVE");
      
      const profile = VK.currentFirmware ? VK.currentFirmware.profile : "NONE";
      slotProfile.textContent = "PROFILE: " + profile;
      romStatus.textContent = profile;
      
      modeStatus.textContent = VK.analysisRunning ? "ACTIVE" : "STANDBY";
      
      // IRIS display state
      if (!VK.displayOn) {
        irisPlaceholder.style.display = "flex";
        irisBars.style.display = "none";
        irisVideo.style.display = "none";
      } else if (VK.irisState === "ACTIVE") {
        irisPlaceholder.style.display = "none";
        irisBars.style.display = "none";
        irisVideo.style.display = "block";
      } else {
        irisPlaceholder.style.display = "none";
        irisBars.style.display = "flex";
        irisVideo.style.display = "none";
      }
    }
    
    // Animation loop
    let lastTime = performance.now();
    function animate() {
      const now = performance.now();
      const dt = (now - lastTime) / 1000;
      lastTime = now;
      
      VK.updateIris(dt);
      VK.updateAudio();
      VUMeters.update();
      
      if (VK.displayOn) {
        VoicePanel.draw();
        NexusPanel.draw();
      }
      
      updateUI();
      requestAnimationFrame(animate);
    }
    
    // Init
    VK.loadDefaultFirmware();
    setStatus("SYSTEM IDLE — PRESS K TO LOAD TOKEN");
    updateUI();
    animate();
  </script>
</body>
</html>
